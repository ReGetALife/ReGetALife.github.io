<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script type="text/javascript" src="http://gc.kis.v2.scr.kaspersky-labs.com/231A5A03-A1A6-B94A-94DC-F29EB782A5C4/main.js"
        charset="UTF-8"></script>
    <title>WUS City Database Online</title>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/getscript?v=2.0&ak=TPlgkDEFHisnIAVdXGOT7WGh"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js"></script>
    <script>
        function startSearch() {
            var city = document.getElementById("searchWord").value;
            document.getElementById("header").innerHTML = "------------" + city + " 城市信息 ------------"
            document.getElementById("container").style.display = "block"
            clear();
            console.log(city)
            getBaiduMap(city);
            getWiki(city);
            getWeather(city);
            getNews(city);
            getEconomy(city);

            return false//返回false是防止跳转的关键
        }
        function clear() {
            $(document.getElementById("news")).children("a").remove();
            $(document.getElementById("weather")).children("div").remove();
            $(document.getElementById("weather")).children("a").remove();
            $(document.getElementById("general")).children("a").remove();
            $(document.getElementById("brief")).children("div").remove();
            $(document.getElementById("brief")).children("a").remove();
            $(document.getElementById("economy")).children("div").remove();
            $(document.getElementById("economy")).children("a").remove();
        }
        function getEconomy(city){
            $.ajax({
                url: "http://139.199.75.41/api/economy",
                data: {
                    s:city,
                    m:"searchdata",
                    db:"",
                    p:0
                },
                dataType: "json",
                success: function (json) {
                   // var json=pako.ungzip(zjson,{ to: 'string' });
                    console.log("economy good");
                    for(var i=0;i<5;i++){
                        var childNode3 = document.createElement('div');
                    childNode3.innerHTML =json.result[i].sj+json.result[i].zb+"："+json.result[i].data;
                    childNode3.style = "float:left;width:400px;text-align:left;";
                    document.getElementById("economy").appendChild(childNode3);
                    }
                    var origin = document.createElement('a');
                    origin.href = "http://data.stats.gov.cn";
                    origin.innerHTML = "信息来源：国家统计局";
                    origin.style = "float:right;width:400px;text-align:right;";
                    document.getElementById("economy").appendChild(origin);
                }
            })
        }
        function getBaiduMap(city) {
            var map = new BMap.Map("allmap");  // 创建Map实例
            map.centerAndZoom(city, 11);
            //添加地图类型控件
            map.addControl(new BMap.MapTypeControl({
                mapTypes: [
                    BMAP_NORMAL_MAP,
                    BMAP_HYBRID_MAP
                ]
            }));
            map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
        }
        function getWiki(city) {
            $.ajax({
                url: "https://zh.wikipedia.org/w/api.php",
                data: {
                    action: "query",
                    format: "xml",
                    origin: "*",
                    generator: "prefixsearch",
                    gpssearch: city,
                    prop: "pageprops|pageimages|description",
                    gpslimit: 5,
                    ppprop: "displaytitle",
                    piprop: "thumbnail",
                    pithumbsize: 50,
                    pilimit: 6,
                    gpsnamespace: 0,
                    callback: "callbackStack.queue[122]",
                    redirects: ""
                },
                dataType: "xml",
                success: function (xml) {
                    //console.log(xml);
                    $(xml).find("page").each(function () {
                        var descr = $(this).attr("description");
                        if (typeof (descr) == "undefined") {
                            descr = " ";
                        } else { descr = ": " + descr; }
                        var ttl = $(this).attr("title");
                        var link = document.createElement('a');
                        link.href = "https://zh.wikipedia.org/wiki/" + ttl;
                        link.style = "float:left;width:800px;text-align:left;";
                        var text = document.createElement("div");
                        text.innerHTML = ttl + descr;
                        text.style = "float:left;";
                        link.appendChild(text);

                        document.getElementById("general").appendChild(link);
                    })

                    var origin = document.createElement('a');
                    origin.href = "https://zh.wikipedia.org";
                    origin.innerHTML = "信息来源：维基百科";
                    origin.style = "float:right;width:400px;text-align:right;";
                    document.getElementById("general").appendChild(origin);

                }
            })
        }
        function getWeather(city) {
            $.ajax({
                type: 'GET',
                url: "http://139.199.75.41/api/weather",
                data: {
                    theCityName: city
                },
                crossDomain: true,
                dataType: "xml",
                success: function (xml) {
                    console.log("weather good");
                    var weatherInfo = $(xml).find("string");
                    var childNode1 = document.createElement('div');

                    var childNode3 = document.createElement('div');
                    childNode3.innerHTML = weatherInfo[6].innerHTML + "：" + weatherInfo[5].innerHTML + "，" + weatherInfo[7].innerHTML;
                    childNode3.style = "float:left;width:400px;text-align:left;";
                    document.getElementById("weather").appendChild(childNode3);
                    var childNode4 = document.createElement('div');
                    childNode4.innerHTML = weatherInfo[13].innerHTML + "：" + weatherInfo[12].innerHTML + "，" + weatherInfo[14].innerHTML;
                    childNode4.style = "float:left;width:400px;text-align:left;";
                    document.getElementById("weather").appendChild(childNode4);
                    var childNode5 = document.createElement('div');
                    childNode5.innerHTML = weatherInfo[18].innerHTML + "：" + weatherInfo[17].innerHTML + "，" + weatherInfo[19].innerHTML;
                    childNode5.style = "float:left;width:400px;text-align:left;";
                    document.getElementById("weather").appendChild(childNode5);
                    childNode1.innerHTML = weatherInfo[10].innerHTML;
                    childNode1.style = "float:left;width:400px;text-align:left;";
                    document.getElementById("weather").appendChild(childNode1);
                    var childNode2 = document.createElement('div');
                    childNode2.innerHTML = weatherInfo[11].innerHTML;
                    childNode2.style = "float:left;width:400px;text-align:left;";
                    document.getElementById("weather").appendChild(childNode2);

                    var origin = document.createElement('a');
                    origin.href = "http://www.webxml.com.cn/zh_cn/index.aspx";
                    origin.innerHTML = "信息来源：webxml.com.cn";
                    origin.style = "float:right;width:400px;text-align:right;";
                    document.getElementById("weather").appendChild(origin);

                    var briefInfo = document.createElement('div');
                    briefInfo.style = "float:left;width:400px;text-align:left;";
                    var t = document.createElement('font');
                    t.innerHTML = weatherInfo[22].innerHTML;
                    t.size = "2";
                    briefInfo.appendChild(t);
                    document.getElementById("brief").appendChild(briefInfo);

                    var origin2 = document.createElement('a');
                    origin2.href = "http://www.webxml.com.cn/zh_cn/index.aspx";
                    origin2.innerHTML = "信息来源：webxml.com.cn";
                    origin2.style = "float:right;width:400px;text-align:right;";
                    document.getElementById("brief").appendChild(origin2);
                }
            })
        }
        function getNews(city) {
            var timestamp = new Date().getTime();
            var signature = md5("fa6c47a72dcf4ae6834b6dc2416db454" + timestamp + "bPrA4mec9wMnIDy8")
            $.ajax({
                type: 'GET',
                url: "http://139.199.75.41/api/news",
                data: {
                    q: city,
                    size: 15,
                    signature: signature,
                    timestamp: timestamp,
                    order: "relevance",
                    access_key: "bPrA4mec9wMnIDy8",
                    callback: "hello"
                },
                crossDomain: true,
                dataType: "json",
                success: function (json) {
                    console.log("news good");

                    for (var i = 0; i < 5; i++) {
                        var childNode = document.createElement('a');
                        var subchildNode = document.createElement('div');
                        subchildNode.innerHTML = json.data.news[i].title;
                        childNode.href = json.data.news[i].url;
                        subchildNode.style = "float:left;width:400px;text-align:left;";
                        childNode.appendChild(subchildNode);
                        document.getElementById("news").appendChild(childNode);
                    }
                    var origin = document.createElement('a');
                    origin.href = "https://shuwen.com/";
                    origin.innerHTML = "信息来源：数闻平台";
                    origin.style = "float:right;width:400px;text-align:right;";
                    document.getElementById("news").appendChild(origin);
                }
            })
        }
    </script>
    <style type="text/css">
        #container {
            overflow: auto
        }

        html,
        #allmap {
            width: 100%;
            height: 100%;
            overflow: auto;
            margin: 0;
            font-family: "微软雅黑";
        }
    </style>
</head>

<body>
    <center>
        <h1>WUS City Database Online</h1>
        <form onsubmit="return startSearch()">
            城市名称: <input type="text" value="" id="searchWord">
            <input type="button" value="查询" onclick="startSearch()">
        </form>

        <div id="container" style="width:1200px;display:none;">

            <div style="">
                <h1 id="header" style="margin-bottom:0;"></h1>
                <br>
            </div>

            <div style="width:800px;float:left;">
                <div style="height:200px;width:800px">
                    <div id="general" style="width:400px;float:left">
                        <h3 style="float:left">城市百科</h3>
                    </div>
                    <div id="news" style="width:400px;float:left">
                        <h3 style="float:left">城市新闻</h3>
                    </div>
                </div>
                <div style="width:800px">
                    
                    <div style="width:400px;float:left">
                        <div id="weather" style="width:400px;">
                            <h3 style="float:left">城市天气</h3>
                        </div>
                        <div id="economy" style="width:400px;">
                            <h3 style="float:left">城市数据</h3>
                        </div>
                    </div>
                    <div id="brief" style="width:400px;float:left">
                        <h3 style="float:left">城市简介</h3>
                    </div>
                </div>
            </div>
            <div>
                <h3 style="float:left">城市地图</h3>
                <div id="allmap" style="height:500px;width:400px;float:left;"></div>
            </div>

        </div>
    </center>
</body>

</html>